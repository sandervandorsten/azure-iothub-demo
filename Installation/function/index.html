


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="IoT application on Azure to connect a RaspberryPi to IoT Hub.">
      
      
        <link rel="canonical" href="https://sandervandorsten.github.io/azure-iothub-demo/Installation/function/">
      
      
        <meta name="author" content="Sander van Dorsten">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.4.0">
    
    
      
        <title>Azure Function: Deploying a function - Azure IoT Hub Demo</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.fe0cca5b.min.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="preference" data-md-color-primary="green" data-md-color-accent="orange">
  
    
      <script>matchMedia("(prefers-color-scheme: dark)").matches&&document.body.setAttribute("data-md-color-scheme","slate")</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#what-is-azure-functions" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://sandervandorsten.github.io/azure-iothub-demo/" title="Azure IoT Hub Demo" class="md-header-nav__button md-logo" aria-label="Azure IoT Hub Demo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Azure IoT Hub Demo
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Azure Function: Deploying a function
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/sandervandorsten/azure-iothub-demo/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sandervandorsten/azure-iothub-demo
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://sandervandorsten.github.io/azure-iothub-demo/" title="Azure IoT Hub Demo" class="md-nav__button md-logo" aria-label="Azure IoT Hub Demo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Azure IoT Hub Demo
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/sandervandorsten/azure-iothub-demo/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    sandervandorsten/azure-iothub-demo
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Azure IoT Hub Demo" class="md-nav__link">
      Azure IoT Hub Demo
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../deploy/" title="Deploying Infrastructure" class="md-nav__link">
      Deploying Infrastructure
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Installing Services
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Installing Services" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Installing Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../iot-hub/" title="IoT Hub: Registering A Device" class="md-nav__link">
      IoT Hub: Registering A Device
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../stream-analytics/" title="Stream Analytics: Starting the analysis job" class="md-nav__link">
      Stream Analytics: Starting the analysis job
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Azure Function: Deploying a function
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Azure Function: Deploying a function" class="md-nav__link md-nav__link--active">
      Azure Function: Deploying a function
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-azure-functions" class="md-nav__link">
    What is Azure Functions?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-the-repository" class="md-nav__link">
    Downloading the repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-our-functions-application-locally" class="md-nav__link">
    Running our functions application locally
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulating-a-raspberrypi-locally" class="md-nav__link">
    Simulating a RaspberryPi Locally
  </a>
  
    <nav class="md-nav" aria-label="Simulating a RaspberryPi Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-the-raspberry-pi" class="md-nav__link">
    Configure the Raspberry Pi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starting-the-raspberry-pi" class="md-nav__link">
    Starting the Raspberry Pi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-your-function-app-to-azure" class="md-nav__link">
    Deploying your function app to Azure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recap" class="md-nav__link">
    Recap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    Next Steps
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Usage
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Usage" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Usage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../Usage/simulated-pi/" title="Using a Simulated RaspberryPi" class="md-nav__link">
      Using a Simulated RaspberryPi
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../Usage/raspberry-pi/" title="Using a Real RaspberryPi" class="md-nav__link">
      Using a Real RaspberryPi
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../links/" title="External links" class="md-nav__link">
      External links
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-azure-functions" class="md-nav__link">
    What is Azure Functions?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#downloading-the-repository" class="md-nav__link">
    Downloading the repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-our-functions-application-locally" class="md-nav__link">
    Running our functions application locally
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simulating-a-raspberrypi-locally" class="md-nav__link">
    Simulating a RaspberryPi Locally
  </a>
  
    <nav class="md-nav" aria-label="Simulating a RaspberryPi Locally">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configure-the-raspberry-pi" class="md-nav__link">
    Configure the Raspberry Pi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#starting-the-raspberry-pi" class="md-nav__link">
    Starting the Raspberry Pi
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    Summary
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging" class="md-nav__link">
    Debugging
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying-your-function-app-to-azure" class="md-nav__link">
    Deploying your function app to Azure
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recap" class="md-nav__link">
    Recap
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    Next Steps
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/sandervandorsten/azure-iothub-demo/edit/master/docs/Installation/function.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1> <img src="https://raw.githubusercontent.com/sandervandorsten/azure-iothub-demo/master/images/azure-functions-logo.png" alt="Azure Functions Logo" align="left" style="height:40px;padding:5px"> Azure Functions: Deploying a function</h1>

<p><img src="https://raw.githubusercontent.com/sandervandorsten/azure-iothub-demo/master/images/azure-iothub-demo.png" alt="Infrastructure Overview" border="1"></p>
<h2 id="what-is-azure-functions">What is Azure Functions?<a class="headerlink" href="#what-is-azure-functions" title="Permanent link">&para;</a></h2>
<p>Azure Functions is a serverless compute service that lets you run event-triggered code without having to explicitly provision or manage infrastructure. A function is "triggered" by a specific type of event. Supported triggers include responding to changes in data, responding to messages, running on a schedule, or as the result of an HTTP request.</p>
<h2 id="usage">Usage<a class="headerlink" href="#usage" title="Permanent link">&para;</a></h2>
<p>In our application, we're going to start a function when we receive a message on our Service Bus Queue. A function can be deployed within Azure Functions, and can be developed locally on your computer. </p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Make sure you have <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest">installed the Azure CLI</a> on your computer</li>
<li>basic knowledge of git + python virtual environments</li>
<li>access to a bash-like terminal</li>
</ul>
<h2 id="downloading-the-repository">Downloading the repository<a class="headerlink" href="#downloading-the-repository" title="Permanent link">&para;</a></h2>
<p>Clone this repository to your computer.
<div class="highlight"><pre><span></span><code>git clone https://github.com/sandervandorsten/azure-iothub-demo.git
<span class="c1"># Cloning into &#39;azure-iothub-demo&#39;...</span>
<span class="c1"># ...</span>
<span class="c1"># Resolving deltas: 100% ..., done.</span>
</code></pre></div></p>
<p>Navigate into the git repository
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> azure-iothub-demo
</code></pre></div></p>
<p>Create a virtual environment with python 3.7 and install the requirements
<div class="highlight"><pre><span></span><code>virtualenv -p <span class="k">$(</span>which python3.7<span class="k">)</span> venv
<span class="nb">source</span> venv/bin/activate
pip install -r requirements.txt
</code></pre></div></p>
<h2 id="running-our-functions-application-locally">Running our functions application locally<a class="headerlink" href="#running-our-functions-application-locally" title="Permanent link">&para;</a></h2>
<p>Now we have our code and python environment locally, we can test our function app locally before we deploy it to our cloud project. </p>
<p>The code that will be run in the function can be found in <a href="https://github.com/sandervandorsten/azure-iothub-demo/blob/master/src/azure_functions/ServiceBusQueueTriggerTemperature/__init__.py"><code>src/azure_functions/ServiceBusQueueTriggerTemperature/__init__.py</code></a> in this repository, you can check it out if you like. </p>
<p>To start our function app locally:</p>
<p>Navigate to the folder containing the source code for Azure Functions
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> src/azure_functions
</code></pre></div>
Download the application settings from the cloud.  These are the environment variables that will be used to connect Azure Functions  to different services, such as storage and the IoT Hub. it will store the configuration files automatically in <code>src/azure_functions/local.settings.json</code>. </p>
<details class="note" open="open"><summary>Replace the functionapp-.... name</summary><p>Remember that you should replace the functionapp name with your own!!</p>
</details>
<div class="highlight"><pre><span></span><code>func azure functionapp fetch-app-settings functionapp-pndvv72m6ihab
<span class="c1"># App Settings:</span>
<span class="c1"># Loading FUNCTIONS_WORKER_RUNTIME = *****</span>
<span class="c1"># Loading FUNCTIONS_EXTENSION_VERSION = *****</span>
<span class="c1"># Loading AzureWebJobsStorage = *****</span>
<span class="c1"># Loading connectionStringListenServiceBus = *****</span>
<span class="c1"># Loading connectionStringIotHub = *****</span>
</code></pre></div>

<p>Start the function app locally. This will start a local webserver on port <code>7071</code>. Our function should then run locally on your computer, but listens to the Service Bus Queue in the cloud. 
<div class="highlight"><pre><span></span><code>func start
<span class="c1"># Found Python version 3.7.5 (python3).</span>

<span class="c1">#                   %%%%%%</span>
<span class="c1">#                  %%%%%%</span>
<span class="c1">#             @   %%%%%%    @</span>
<span class="c1">#           @@   %%%%%%      @@</span>
<span class="c1">#        @@@    %%%%%%%%%%%    @@@</span>
<span class="c1">#      @@      %%%%%%%%%%        @@</span>
<span class="c1">#        @@         %%%%       @@</span>
<span class="c1">#          @@      %%%       @@</span>
<span class="c1">#            @@    %%      @@</span>
<span class="c1">#                 %%</span>
<span class="c1">#                 %</span>
<span class="c1"># ...</span>
<span class="c1"># Content root path: /.../azure-iothub-demo/src/azure_functions</span>
<span class="c1"># Now listening on: http://0.0.0.0:7071</span>
<span class="c1"># Application started. Press Ctrl+C to shut down.</span>
</code></pre></div></p>
<h2 id="simulating-a-raspberrypi-locally">Simulating a RaspberryPi Locally<a class="headerlink" href="#simulating-a-raspberrypi-locally" title="Permanent link">&para;</a></h2>
<p>Running our function app was the last step of infrastructure that we should enable before we can start testing our whole setup. Now, we need to connect a IoT Device to the IoT Hub s.t. we can send device-to-cloud telemetry towards our cloud application, and receive cloud-to-device messages from our function app. </p>
<p>I've created a Raspberry Pi Interface in <code>azure-iothub-demo/src/iothub/device.py</code> that we're going to use to <strong>simulate a Raspberry Pi</strong>. You can connect your own raspberry Pi to do the actual work, but this is (currently) beyond the scope of this tutorial. </p>
<p>To start a Raspberry Pi simulation, open an extra terminal window (leaving the one running the function app open!) and running the following snippets:</p>
<h3 id="configure-the-raspberry-pi">Configure the Raspberry Pi<a class="headerlink" href="#configure-the-raspberry-pi" title="Permanent link">&para;</a></h3>
<p>Navigate to the <code>azure-iothub-demo</code> folder and activate the virtual environment in this terminal as well
<div class="highlight"><pre><span></span><code><span class="nb">source</span> venv/bin/activate
</code></pre></div>
Copy the <code>sample.env</code> file to <code>.env</code> file s.t. we can store essential credentials here later
<div class="highlight"><pre><span></span><code>cp sample.env .env
</code></pre></div></p>
<p>Save your unique IoT Hub name (see your own Azure Portal with the name of your Iot Hub resource) and DeviceId s.t. we can use them below
<div class="highlight"><pre><span></span><code><span class="nb">export</span> <span class="nv">IoTHubName</span><span class="o">=</span><span class="s2">&quot;rpi-iothub-.........&quot;</span>
<span class="nb">export</span> <span class="nv">deviceId</span><span class="o">=</span><span class="s2">&quot;MyRaspberryPi&quot;</span>
</code></pre></div></p>
<p>An alternative way of interacting with the cloud is through the Azure CLI. Download the Azure CLI IoT Hub Extension to interact with your cloud application from the terminal. In this way, we don't have to access the Azure Portal and click through it. 
<div class="highlight"><pre><span></span><code>az extension add --name azure-iot
</code></pre></div></p>
<p>Access the connection string for the IoT Hub in your terminal
<div class="highlight"><pre><span></span><code>az iot hub show-connection-string <span class="se">\</span>
  --name <span class="nv">$IoTHubName</span> <span class="se">\</span>
  --output table
<span class="c1">#HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI=</span>
</code></pre></div>
Access the Connection String for the DeviceId you've created in IoT Hub. 
<div class="highlight"><pre><span></span><code>az iot hub device-identity show-connection-string <span class="se">\</span>
  --hub-name <span class="nv">$IoTHubName</span> <span class="se">\</span>
  --device-id <span class="nv">$deviceId</span> <span class="se">\</span>
  --output table
<span class="c1">#HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ=</span>
</code></pre></div></p>
<p>Now, <strong>open the</strong> <code>.env</code> <strong>file</strong> with a text editor and replace the string values s.t. it looks like this
  <div class="highlight"><pre><span></span><code><span class="nv">DEVICE_ID</span><span class="o">=</span><span class="s2">&quot;MyRaspberryPi&quot;</span>
<span class="nv">CONNECTION_STRING_IOT_DEVICE</span><span class="o">=</span><span class="s2">&quot;HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ=&quot;</span>
<span class="nv">CONNECTION_STRING_IOT_HUB</span><span class="o">=</span><span class="s2">&quot;HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI=&quot;</span>
</code></pre></div>
Save the .env file and close it. </p>
<details class="warning" open="open"><summary>.env file</summary><p><strong>This file contains credentials and should not be shared, or stored publicly!</strong> </p>
</details>
<h3 id="starting-the-raspberry-pi">Starting the Raspberry Pi<a class="headerlink" href="#starting-the-raspberry-pi" title="Permanent link">&para;</a></h3>
<p>Now the configuration is finished, <strong>you can start the RaspberryPi simulation</strong>. the Simulated Raspberry Pi will:</p>
<ul>
<li>send a random temperature value every 3 seconds to the IoT Hub.</li>
<li>listen to it's IoT Hub for messages. Our function app will send messages to the device through the IoT Hub to start the fan if <code>temperature &gt; 29</code> (as configured in our Stream Analytics Job). The fan will then be turned on for 10 seconds, and deactivated afterwards. Hence, if the temperature will stay above 29 degrees, the fan will stay on because the RaspberryPi will keep receiving messages to turn on the fan.</li>
</ul>
<p>Navigate to the iothub folder and run the Raspberry Pi simulation
<div class="highlight"><pre><span></span><code><span class="nb">cd</span> src/iothub
python main.py --RPi SimulatedRaspberryPi
<span class="c1"># IoT Hub device sending periodic messages, press Ctrl-C to exit</span>
<span class="c1"># Sending message: {&quot;temperature&quot;: 33.794175910136936, &quot;fan_active&quot;: false}</span>
<span class="c1"># Message sent</span>
<span class="c1"># Sending message: {&quot;temperature&quot;: 22.667180109040924, &quot;fan_active&quot;: false}</span>
<span class="c1"># Message sent</span>
<span class="c1"># ...</span>
</code></pre></div></p>
<p>Once the Raspberry Pi sends a message with a <code>temperature &gt; 29</code>, this message will be forwarded by the Stream Analytics Job to the Service Bus Queue. Once this message arrives on the Service Bus Queue, it will trigger the Function app (that is running locally on your computer), which sends a message through the IoTHub to the device that the fan should be activated. <strong>The logs in your (other) terminal of your function app should look something like this:</strong></p>
<div class="highlight"><pre><span></span><code>[7/14/2020 9:53:43 AM] ...
[7/14/2020 9:53:43 AM] Executing &#39;Functions.ServiceBusQueueTriggerTemperature&#39; (Reason=&#39;New ServiceBus message detected on &#39;temperature&#39;.&#39;, Id=161614bf-3d3a-40f7-8608-7e2c88d08ba0)
[7/14/2020 9:53:43 AM] Trigger Details: MessageId: a5f9ddcd698142e495a1cec97f954071, DeliveryCount: 10, EnqueuedTime: 7/14/2020 9:53:42 AM, LockedUntil: 7/14/2020 9:58:43 AM, SessionId: 18725
[7/14/2020 9:53:43 AM]  INFO: Received FunctionInvocationRequest, request ID: 2f46689a-8f66-4dab-88da-6381e553e3f2, function ID: 4065367e-45d4-45f3-bb6e-416b2fdeed51, invocation ID: 161614bf-3d3a-40f7-8608-7e2c88d08ba0
[7/14/2020 9:53:43 AM] Python ServiceBus queue trigger processed message: {&#39;temperature&#39;: 30.463195551136046, &#39;fan_active&#39;: 1, &#39;EventProcessedUtcTime&#39;: &#39;2020-07-14T09:53:36.6114953Z&#39;, &#39;PartitionId&#39;: 1, &#39;EventEnqueuedUtcTime&#39;: &#39;2020-07-14T09:53:36.5600000Z&#39;, &#39;IoTHub&#39;: {&#39;MessageId&#39;: None, &#39;CorrelationId&#39;: None, &#39;ConnectionDeviceId&#39;: &#39;MyRaspberryPi&#39;, &#39;ConnectionDeviceGenerationId&#39;: &#39;637298794990585953&#39;, &#39;EnqueuedTime&#39;: &#39;2020-07-14T09:53:36.0000000&#39;, &#39;StreamId&#39;: None}}
[7/14/2020 9:53:43 AM] Device Method called
[7/14/2020 9:53:43 AM] Device Method name       : start_fan
[7/14/2020 9:53:43 AM] Device Method payload    : {}
[7/14/2020 9:53:43 AM] Response status          : 200
[7/14/2020 9:53:43 AM] Response payload         : {&#39;Response&#39;: &#39;The fan has been (re)activated at 2020-07-14 11:53:43.095383&#39;}
[7/14/2020 9:53:43 AM] ...
</code></pre></div>

<h3 id="summary">Summary<a class="headerlink" href="#summary" title="Permanent link">&para;</a></h3>
<p>You should now have <strong>two terminal windows open</strong>. One with a locally running function app, and one with a Simulated Raspberry Pi. Messages should be flowing back and forth between the services. </p>
<h3 id="debugging">Debugging<a class="headerlink" href="#debugging" title="Permanent link">&para;</a></h3>
<p>If this is not the case:</p>
<ul>
<li>Check if your <code>.env</code> file is configured correctly s.t. your Simulated Raspberry Pi can send data to the cloud.</li>
<li>Make sure your Stream Analytics Job is running (see: <a href="../stream-analytics/">Starting the analysis job on Stream Analytics</a>)</li>
<li>
<p>Verify if messages are received on the cloud by checking </p>
<ul>
<li>if data is written to the storage account container named <code>temperature</code>. This should contain one or multiple jsonfiles with data from the Raspberry Pi.</li>
<li>if messages are sent to the Service Bus Queue. You can navigate in the Azure Portal to the Queue and look if there are messages in the Queue. </li>
</ul>
<details class="warning" open="open"><summary>Empty Service Bus Queue</summary><p>Remember that if your function app is running (locally), <strong>it will consume all messages on that queue instantly</strong>, hence the queue will become empty almost instantaniously whilst the function app is running. </p>
</details>
</li>
</ul>
<h2 id="deploying-your-function-app-to-azure">Deploying your function app to Azure<a class="headerlink" href="#deploying-your-function-app-to-azure" title="Permanent link">&para;</a></h2>
<p>Now your function app is tested locally, you can deploy it to Azure. You can stop the services in both terminals.</p>
<p>Deploy the function to Azure. (replace the function app name with your own)
<div class="highlight"><pre><span></span><code>func azure functionapp publish functionapp-pndvv72m6ihab
</code></pre></div>
This will use the Azure Functions library (which you have installed in the virtual environment) to deploy your function to the cloud. After a minute or so you can open the Azure Portal, navigate to your function app and find your function deployed and well.</p>
<p align="center">
  <img src="https://raw.githubusercontent.com/sandervandorsten/azure-iothub-demo/master/images/functionapp.png" alt="Function App" border="2" height="100%" width="100%">
</p>

<h2 id="recap">Recap<a class="headerlink" href="#recap" title="Permanent link">&para;</a></h2>
<ul>
<li>You have configured and tested a pre-built Azure Function to work on your local machine. </li>
<li>You have deployed this function to the cloud using the python library for Azure Functions. </li>
<li>You have Simulated a Raspberry Pi and have sent/received data from and to the cloud.</li>
</ul>
<h2 id="next-steps">Next Steps<a class="headerlink" href="#next-steps" title="Permanent link">&para;</a></h2>
<p>Now our infrastructure is fully deployed you can use a real or simulated Raspberry Pi to send data to the cloud. If you're creative, you can start extending this infrastructure if:</p>
<ul>
<li>You want to create a dashboard with PowerBI, you can <a href="https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-power-bi-dashboard">add PowerBI as an output to Stream Analytics</a></li>
<li>You want to <a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-get-started-physical">register more IoT devices to IoT Hub</a> </li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../stream-analytics/" title="Stream Analytics: Starting the analysis job" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Stream Analytics: Starting the analysis job
              </div>
            </div>
          </a>
        
        
          <a href="../../Usage/simulated-pi/" title="Using a Simulated RaspberryPi" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Using a Simulated RaspberryPi
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Sander van Dorsten
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/sandervandorsten" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://linkedin.com/in/sandervandorsten" target="_blank" rel="noopener" title="linkedin.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="../../assets/javascripts/bundle.b39636ac.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: ["instant"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.a68abb33.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>