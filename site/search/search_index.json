{"config":{"lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Azure IoT Hub Demo \u00b6 IoT application on Azure to connect a RaspberryPi to IoT Hub . Sends device-to-cloud telemetry and allows cloud-to-device callbacks to the Raspberry Pi. Report Bug \u00b7 Request Feature Do you want to have a fresh breeze in you home office, but are you to lazy to turn on the fan yourself? With this project you'll have your office cooled down in notime! About The Project \u00b6 This project helps you setup a relatively simple Azure Infrastructure for connecting your own Raspberry Pi to the cloud. You can use this as a starting point to develop small IoT applications. Features \u00b6 The possibility to simulate a Raspberry Pi from your computer to speed up development Simple data storage in a container for 'cold' analysis data flowing through Stream Analytics to perform live analysis and send this along to other Azure Services Infrastructure as code using ARM templates so you can deploy your own easily Estimated costs: < 10EUR / Month (if you set IoT Hub to use a free account, limited to 1 per subscription) An easily extendable infrastructure, for example if: You want to create a dashboard with PowerBI, you can add PowerBI as an output to Stream Analytics . You want to register more IoT devices to IoT Hub Background \u00b6 I started this project whilst working from home on different coding projects on Azure in the summer during the COVID-19 outbreak. Whilst working from home certainly has it's advantages, I did miss the AC that we have at the office at times. Whilst the temperature in my home-office sky-rocketed in June, I bought a ventilator to keep me cool. This was great, however having it turned on at all times is a bit of an overkill as it is certainly not hot all day-everyday here in the Netherlands. My ventilator however did not support temperature-based-control, hence I wanted to build this myself. I had a Raspberry Pi lying around so wanted to use this as an interface for measuring temperature and controlling the ventilator. As I was working on a number of projects in Azure, I wondered if I could use their cloud services to connect this raspberry Pi to the cloud. Hence I asked myself: Can I connect a Raspberry Pi to IoT Hub to 1) send device-to-cloud telemetry data and 2) trigger the ventilator on my desk with a cloud-to-device message? In my mind, the application should contain a few components: Raspberry Pi: stream temperature data from device to the cloud. listen to signal that triggers fan activation from the cloud. 'arbitrary-cloud-services': data should be stored somewhere Once a certain temperature threshold has been exceded, a message should be returned to the Raspberry Pi to trigger the fan. Infrastructure \u00b6 I ended up selecting the following infrastructure based on this video : Raspberry Pi to connect sensor and fan to. This project also includes a simulated Raspberry Pi device that you can run on your computer to speed up development. Azure IoT Hub . Allows you to securely connect IoT devices to Azure cloud, from which you can further route messages to different services. Stream Analytics . Performs streaming data analysis on your IoT input data and forwards the data to specified services. Blob Storage . Cold storage for the data. Service Bus Queue . Queue used as input/trigger for Azure Functions. Functions . Serverless function that is triggered by the aforementioned Service Bus Queue, and sends a message via IoT Hub to the Connected Raspberry Pi device. Control Flow \u00b6 A Raspberry Pi collects data from a connected temperature sensor. It sends this so-called telemetry data to it's designated IoT Hub. The IoT Hub processess incoming and outgoing requests from/to connected IoT devices. It has a Messaging Endpoint, from which Stream Analytics ingests the Raspberry Pi temperature telemetry for further processing. Stream Analytics writes all telemetry temperature data to a blob storage, and writes a subset of the temperatures to a Queue on the Service Bus. In this example, we send only the telemetry data temperature > 29 to the Queue. When a new message is stored on the Queue, a Azure Function is triggered. The function app sends a message to the IoT hub that the fan of the connected Raspberry Pi should turn on. Effectively in our example this means that the fan will turn on for a while if, and only if temperature > 29 . The IoT Hub securely forwards the message to the Raspberry Pi to start the connected ventilator. Getting Started \u00b6 In this step-by-step guide I'll help you set up everything to get your own application up and running. The setup is going to cover the following parts: Deploying your own copy of the infrastructure to Azure using ARM templates Installing and configuring the individual services, specifically: IoT Hub: Registering a (simulated) Raspberry Pi device Stream Analytics: Starting our analysis job Azure Function: Deploying a function Downloading the repository Running our functions application locally Simulating a RaspberryPi Locally Deploying your function app to Azure","title":"Azure IoT Hub Demo"},{"location":"#azure-iot-hub-demo","text":"IoT application on Azure to connect a RaspberryPi to IoT Hub . Sends device-to-cloud telemetry and allows cloud-to-device callbacks to the Raspberry Pi. Report Bug \u00b7 Request Feature Do you want to have a fresh breeze in you home office, but are you to lazy to turn on the fan yourself? With this project you'll have your office cooled down in notime!","title":"Azure IoT Hub Demo"},{"location":"#about-the-project","text":"This project helps you setup a relatively simple Azure Infrastructure for connecting your own Raspberry Pi to the cloud. You can use this as a starting point to develop small IoT applications.","title":"About The Project"},{"location":"#features","text":"The possibility to simulate a Raspberry Pi from your computer to speed up development Simple data storage in a container for 'cold' analysis data flowing through Stream Analytics to perform live analysis and send this along to other Azure Services Infrastructure as code using ARM templates so you can deploy your own easily Estimated costs: < 10EUR / Month (if you set IoT Hub to use a free account, limited to 1 per subscription) An easily extendable infrastructure, for example if: You want to create a dashboard with PowerBI, you can add PowerBI as an output to Stream Analytics . You want to register more IoT devices to IoT Hub","title":"Features"},{"location":"#background","text":"I started this project whilst working from home on different coding projects on Azure in the summer during the COVID-19 outbreak. Whilst working from home certainly has it's advantages, I did miss the AC that we have at the office at times. Whilst the temperature in my home-office sky-rocketed in June, I bought a ventilator to keep me cool. This was great, however having it turned on at all times is a bit of an overkill as it is certainly not hot all day-everyday here in the Netherlands. My ventilator however did not support temperature-based-control, hence I wanted to build this myself. I had a Raspberry Pi lying around so wanted to use this as an interface for measuring temperature and controlling the ventilator. As I was working on a number of projects in Azure, I wondered if I could use their cloud services to connect this raspberry Pi to the cloud. Hence I asked myself: Can I connect a Raspberry Pi to IoT Hub to 1) send device-to-cloud telemetry data and 2) trigger the ventilator on my desk with a cloud-to-device message? In my mind, the application should contain a few components: Raspberry Pi: stream temperature data from device to the cloud. listen to signal that triggers fan activation from the cloud. 'arbitrary-cloud-services': data should be stored somewhere Once a certain temperature threshold has been exceded, a message should be returned to the Raspberry Pi to trigger the fan.","title":"Background"},{"location":"#infrastructure","text":"I ended up selecting the following infrastructure based on this video : Raspberry Pi to connect sensor and fan to. This project also includes a simulated Raspberry Pi device that you can run on your computer to speed up development. Azure IoT Hub . Allows you to securely connect IoT devices to Azure cloud, from which you can further route messages to different services. Stream Analytics . Performs streaming data analysis on your IoT input data and forwards the data to specified services. Blob Storage . Cold storage for the data. Service Bus Queue . Queue used as input/trigger for Azure Functions. Functions . Serverless function that is triggered by the aforementioned Service Bus Queue, and sends a message via IoT Hub to the Connected Raspberry Pi device.","title":"Infrastructure"},{"location":"#control-flow","text":"A Raspberry Pi collects data from a connected temperature sensor. It sends this so-called telemetry data to it's designated IoT Hub. The IoT Hub processess incoming and outgoing requests from/to connected IoT devices. It has a Messaging Endpoint, from which Stream Analytics ingests the Raspberry Pi temperature telemetry for further processing. Stream Analytics writes all telemetry temperature data to a blob storage, and writes a subset of the temperatures to a Queue on the Service Bus. In this example, we send only the telemetry data temperature > 29 to the Queue. When a new message is stored on the Queue, a Azure Function is triggered. The function app sends a message to the IoT hub that the fan of the connected Raspberry Pi should turn on. Effectively in our example this means that the fan will turn on for a while if, and only if temperature > 29 . The IoT Hub securely forwards the message to the Raspberry Pi to start the connected ventilator.","title":"Control Flow"},{"location":"#getting-started","text":"In this step-by-step guide I'll help you set up everything to get your own application up and running. The setup is going to cover the following parts: Deploying your own copy of the infrastructure to Azure using ARM templates Installing and configuring the individual services, specifically: IoT Hub: Registering a (simulated) Raspberry Pi device Stream Analytics: Starting our analysis job Azure Function: Deploying a function Downloading the repository Running our functions application locally Simulating a RaspberryPi Locally Deploying your function app to Azure","title":"Getting Started"},{"location":"deploy/","text":"Deploying Infrastructure \u00b6 Prerequisites \u00b6 Azure account with a subscription you are allowed to create resources in (Free Trial Subscription should do) Make sure you have installed the Azure CLI on your computer basic knowledge of git + python virtual environments access to a bash-like terminal Deploying Infrastructure \u00b6 I've defined the infrastructure in an ARM template . This allows you to press the button below and deploy the infrastructure to your own Azure account with the click of a button. Press the 'Deploy to Azure' button above to create a custom deployment in Azure Login to your Azure Account where you want to create the application (if not logged in yet) You should then see the Custom Deployment screen as in the screenshot below. Here you can specify some settings for the Deployment. Select a subscription in which you want to create the resources in Create a new resourcegroup in which you want to deploy these resources Keep all the other settings as default, unless you know what you're doing and want to change something Scroll down, accept the terms and conditions and click Purchase. IMPORTANT Remember that this deployment and the running of it will cost you money. For me, I didn't pay more that a few euros and I let it run for a month or so. Please remember to remove your resources if you're not using them anymore! After a couple of minutes (+- 5 minutes I guess) your infrastructure deployment should be completed. Navigate to the resource group you've created to see the different services you've deployed. Next Steps \u00b6 Now you have deployed your infrastructure, we can start and configure the different services that we're going to need to run our application.","title":"Deploying Infrastructure"},{"location":"deploy/#deploying-infrastructure","text":"","title":"Deploying Infrastructure"},{"location":"deploy/#prerequisites","text":"Azure account with a subscription you are allowed to create resources in (Free Trial Subscription should do) Make sure you have installed the Azure CLI on your computer basic knowledge of git + python virtual environments access to a bash-like terminal","title":"Prerequisites"},{"location":"deploy/#deploying-infrastructure_1","text":"I've defined the infrastructure in an ARM template . This allows you to press the button below and deploy the infrastructure to your own Azure account with the click of a button. Press the 'Deploy to Azure' button above to create a custom deployment in Azure Login to your Azure Account where you want to create the application (if not logged in yet) You should then see the Custom Deployment screen as in the screenshot below. Here you can specify some settings for the Deployment. Select a subscription in which you want to create the resources in Create a new resourcegroup in which you want to deploy these resources Keep all the other settings as default, unless you know what you're doing and want to change something Scroll down, accept the terms and conditions and click Purchase. IMPORTANT Remember that this deployment and the running of it will cost you money. For me, I didn't pay more that a few euros and I let it run for a month or so. Please remember to remove your resources if you're not using them anymore! After a couple of minutes (+- 5 minutes I guess) your infrastructure deployment should be completed. Navigate to the resource group you've created to see the different services you've deployed.","title":"Deploying Infrastructure"},{"location":"deploy/#next-steps","text":"Now you have deployed your infrastructure, we can start and configure the different services that we're going to need to run our application.","title":"Next Steps"},{"location":"file2/","text":"Addons \u00b6 Summary Here's some content. Emoji \u00b6 Emojis from https://emojicopy.com","title":"Addons"},{"location":"file2/#addons","text":"Summary Here's some content.","title":"Addons"},{"location":"file2/#emoji","text":"Emojis from https://emojicopy.com","title":"Emoji"},{"location":"links/","text":"External Links and resources \u00b6 Introduction to building IoT Solutions with Microsoft Azure (YouTube) Azure For Everyone Tutorials by Adam Marczak (YouTube)","title":"External links"},{"location":"links/#external-links-and-resources","text":"Introduction to building IoT Solutions with Microsoft Azure (YouTube) Azure For Everyone Tutorials by Adam Marczak (YouTube)","title":"External Links and resources"},{"location":"old/","text":"In this step-by-step guide we'll help you set up everything to get your own application up and running. The setup is going to cover the following parts: Deploying your own copy infrastructure to Azure using ARM templates Starting and configuring the individual services , specifically: Registering a (simulated) Raspberry Pi device on IoT Hub Starting our analysis job on Stream Analytics Deploying a function to Azure Functions Downloading the repository Running our functions application locally Simulating a RaspberryPi Locally Deploying your function app to Azure Prerequisites \u00b6 Azure account with a subscription you are allowed to create resources in (Free Trial Subscription should do) Make sure you have installed the Azure CLI on your computer basic knowledge of git + python virtual environments access to a bash-like terminal Deploying Infrastructure \u00b6 I've defined the infrastructure in an ARM template . This allows you to press the button below and deploy the infrastructure to your own Azure account with the click of a button. Press the 'Deploy to Azure' button above to create a custom deployment in Azure Login to your Azure Account where you want to create the application (if not logged in yet) You should then see the Custom Deployment screen as in the screenshot below. Here you can specify some settings for the Deployment. Select a subscription in which you want to create the resources in Create a new resourcegroup in which you want to deploy these resources Keep all the other settings as default, unless you know what you're doing and want to change something Scroll down, accept the terms and conditions and click Purchase. IMPORTANT Remember that this deployment and the running of it will cost you money. For me, I didn't pay more that a few euros and I let it run for a month or so. Please remember to remove your resources if you're not using them anymore! After a couple of minutes (+- 5 minutes I guess) your infrastructure deployment should be completed. Navigate to the resource group you've created to see the different services you've deployed. Starting Services \u00b6 You should now have the individual components deployed within your Resource Group. Navigate to your resource group overview, and you'll see something like this. To use our end-to-end application, we must activate and configure some of our individual services. We're going to do that now. Registering a device on IoT Hub \u00b6 The Azure IoT Hub is a managed service, hosted in the cloud, that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages. You can use Azure IoT Hub to build IoT solutions with reliable and secure communications between millions of IoT devices and a cloud-hosted solution backend. You can connect virtually any device to IoT Hub. Today we're going to connect only one device. To register a device on IoT Hub: 1. Go to your IoT Hub resource and select the menu blade IoT Devices (see screenshot below) 2. Register a New device by clicking + New 3. In the \"Create a Device\" tab, write down a Device ID , for example MyRaspberryPi . This should be a identifier unique within the IoT Hub. 4. Leave everything else to it's default values and press Save . 5. You have succesfully registered a device on IoT Hub ! You will come back to this screen later to copy the (Primary) Connection String to your local configuration file (your .env file) to allow your device to connect to IoT Hub. We will do this later though, once we're doing configuring the infrastructure. Starting the analysis job on Stream Analytics \u00b6 Azure Stream Analytics is a real-time analytics and complex event-processing engine that is designed to analyze and process high volumes of fast streaming data from multiple sources simultaneously. Patterns can be identified from a number of input sources including devices, sensors and applications. These patterns can be used to trigger actions and initiate workflows such as creating alerts, feeding information to a reporting tool, or storing transformed data for later use. We will use Stream Analytics to ingest data from IoT Hub and move it to both Blob Storage and a Service Bus Queue for more complex actions. This is already configured for you when the infrastructure was deployed, the only thing we need to do is Start the Streaming Job . Navigate to your Stream Analytics resource and you will see the the Overview page . On the bottom right you will see the Query that is already pre-defined. This query does 2 things. (it shown below as well for convenience) it moves all data from the input called iothub to the output called blobstorage it moves all data where temperature > 29 from the input called iothub to the output called servicebus SELECT * INTO blobstorage FROM iothub SELECT * INTO servicebus FROM iothub WHERE temperature > 29 If you want to learn how this input and outputs are actually coupled to the IoT Hub and Service Bus in our infrastructure, you can navigate to the menu blades on the left of your screen called inputs and outputs (under Job Topology ). At deployment time, the bindings to these services were already done for you so you don't have to worry about them. If you want to learn how to create these yourself, I recommend This video by Adam Marczak on Azure Stream Analytics. I fact, I recommend all his Azure tutorials, which helped me a great deal in developing this project. Now you know roughly what happens in Stream Analytics, we can start this Stream Analytics Job to start processing incoming requests. Remember that we're not sending any data from a device yet to our application, but we're just preconfiguring the infrastrature. Press the > Start button at the top of the Overview menu to start the job. It takes about a minute or two to activate, you can see the status straight below it. (see screenshot below) You have sucessfully started your Steam Analytics job! In a bit, our Raspberry Pi Data will flow through this job to the connected services. Now it's not doing anything yet though, So lets quickly finish up our infrastructure setup to start sending data. Cost saving Tip: Pause your stream Analytics job once your done developing. You don't pay per request, but per hour. Deploying a function to Azure Functions \u00b6 Azure Functions is a serverless compute service that lets you run event-triggered code without having to explicitly provision or manage infrastructure. A function is \"triggered\" by a specific type of event. Supported triggers include responding to changes in data, responding to messages, running on a schedule, or as the result of an HTTP request. In our application, we're going to start a function when we receive a message on our Service Bus Queue. A function can be deployed within Azure Functions, and can be developed locally on your computer. We're going to deploy a function that I already prepared for this demo. Make sure you have installed the Azure CLI on your computer. you can test this by running az --version in your terminal. \u00bc: Downloading the repository \u00b6 # 1. Clone this repository to your computer. git clone https://github.com/sandervandorsten/azure-iothub-demo.git # Cloning into 'azure-iothub-demo'... # ... # Resolving deltas: 100% ..., done. # 2. navigate into the git repository cd azure-iothub-demo # 3. Create a virtual environment with python 3.7 and install the requirements virtualenv -p $( which python3.7 ) venv source venv/bin/activate pip install -r requirements.txt 2/4: Running our functions application locally \u00b6 Now we have our code and python environment locally, we can test our function app locally before we deploy it to our cloud project. The code that will be run in the function can be found in src/azure_functions/ServiceBusQueueTriggerTemperature/__init__.py in this repository, you can check it out if you like. To start our function app locally: # 1. Navigate to the folder containing the source code for Azure Functions cd src/azure_functions # 2. Download the application settings from the cloud. # These are the environment variables that will be used to connect Azure Functions # to different services, such as storage and the IoT Hub. # it will store the configuration files automatically in `src/azure_functions/local.settings.json`. # Note that you should replace the functionapp name with your own!! func azure functionapp fetch-app-settings functionapp-pndvv72m6ihab # App Settings: # Loading FUNCTIONS_WORKER_RUNTIME = ***** # Loading FUNCTIONS_EXTENSION_VERSION = ***** # Loading AzureWebJobsStorage = ***** # Loading connectionStringListenServiceBus = ***** # Loading connectionStringIotHub = ***** # 3. Start the function app locally. This will start a local webserver on port 7071. # Our function should then run locally on your computer, # but listens to the Service Bus Queue in the cloud. func start # Found Python version 3.7.5 (python3). # %%%%%% # %%%%%% # @ %%%%%% @ # @@ %%%%%% @@ # @@@ %%%%%%%%%%% @@@ # @@ %%%%%%%%%% @@ # @@ %%%% @@ # @@ %%% @@ # @@ %% @@ # %% # % # ... # Content root path: /.../azure-iothub-demo/src/azure_functions # Now listening on: http://0.0.0.0:7071 # Application started. Press Ctrl+C to shut down. \u00be: Simulating a RaspberryPi Locally \u00b6 Running our function app was the last step of infrastructure that we should enable before we can start testing our whole setup. Now, we need to connect a IoT Device to the IoT Hub s.t. we can send device-to-cloud telemetry towards our cloud application, and receive cloud-to-device messages from our function app. I've created a Raspberry Pi Interface in azure-iothub-demo/src/iothub/device.py that we're going to use to simulate a Raspberry Pi . You can connect your own raspberry Pi to do the actual work, but this is (currently) beyond the scope of this tutorial. To start a Raspberry Pi simulation, open an extra terminal window (leaving the one running the function app open!) and running the following snippets: # 0. Navigate to the azure-iothub-demo folder and activate the virtual environment in this terminal as well source venv/bin/activate # 1. Copy the sanmple.env file to .env file s.t. we can store essential credentials here later cp sample.env .env # 2. Download the azure IoT Hub Extension to interact with our cloud application az extension add --name azure-iot # 3. Save your unique IoT Hub name (see your own Azure Portal with the name of your Iot Hub resource Name) and DeviceId s.t. we can use them below export IoTHubName = \"rpi-iothub-.........\" export deviceId = \"MyRaspberryPi\" # 4. Access the connection string for the IoT Hub in your terminal az iot hub show-connection-string \\ --name $IoTHubName \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI= # 5. Access the Connection String for the DeviceId you've created in IoT Hub. az iot hub device-identity show-connection-string \\ --hub-name $IoTHubName \\ --device-id $deviceId \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ= Now, open the .env file with a text editor and replace the string values s.t. it looks like this DEVICE_ID = \"MyRaspberryPi\" CONNECTION_STRING_IOT_DEVICE = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ=\" CONNECTION_STRING_IOT_HUB = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI=\" Save the .env file and close it. . This file contains credentials and should not be shared, or stored publicly! Now the configuration is finished, you can start the RaspberryPi simulation . the Simulated Raspberry Pi will: send a random temperature value every 3 seconds to the IoT Hub. listen to it's IoT Hub for messages. Our function app will send messages to the device through the IoT Hub to start the fan if temperature > 29 (as configured in our Stream Analytics Job). The fan will then be turned on for 10 seconds, and deactivated afterwards. Hence, if the temperature will stay above 29 degrees, the fan will stay on because the RaspberryPi will keep receiving messages to turn on the fan. To start the Raspberry Pi simulation , re-use the second terminal window and execute the following commands: # 6. navigate to the iothub folder and run the Raspberry Pi simulation cd src/iothub python main.py --RPi SimulatedRaspberryPi # IoT Hub device sending periodic messages, press Ctrl-C to exit # Sending message: {\"temperature\": 33.794175910136936, \"fan_active\": false} # Message sent # Sending message: {\"temperature\": 22.667180109040924, \"fan_active\": false} # Message sent # ... Once the Raspberry Pi sends a message with a temperature > 29 , this message will be forwarded by the Stream Analytics Job to the Service Bus Queue. Once this message arrives on the Service Bus Queue, it will trigger the Function app (that is running locally on your computer), which sends a message through the IoTHub to the device that the fan should be activated. The logs in your terminal of your function app should look something like this: [7/14/2020 9:53:43 AM] Executing 'Functions.ServiceBusQueueTriggerTemperature' (Reason='New ServiceBus message detected on 'temperature'.', Id=161614bf-3d3a-40f7-8608-7e2c88d08ba0) [7/14/2020 9:53:43 AM] Trigger Details: MessageId: a5f9ddcd698142e495a1cec97f954071, DeliveryCount: 10, EnqueuedTime: 7/14/2020 9:53:42 AM, LockedUntil: 7/14/2020 9:58:43 AM, SessionId: 18725 [7/14/2020 9:53:43 AM] INFO: Received FunctionInvocationRequest, request ID: 2f46689a-8f66-4dab-88da-6381e553e3f2, function ID: 4065367e-45d4-45f3-bb6e-416b2fdeed51, invocation ID: 161614bf-3d3a-40f7-8608-7e2c88d08ba0 [7/14/2020 9:53:43 AM] Python ServiceBus queue trigger processed message: {'temperature': 30.463195551136046, 'fan_active': 1, 'EventProcessedUtcTime': '2020-07-14T09:53:36.6114953Z', 'PartitionId': 1, 'EventEnqueuedUtcTime': '2020-07-14T09:53:36.5600000Z', 'IoTHub': {'MessageId': None, 'CorrelationId': None, 'ConnectionDeviceId': 'MyRaspberryPi', 'ConnectionDeviceGenerationId': '637298794990585953', 'EnqueuedTime': '2020-07-14T09:53:36.0000000', 'StreamId': None}} [7/14/2020 9:53:43 AM] Device Method called [7/14/2020 9:53:43 AM] Device Method name : start_fan [7/14/2020 9:53:43 AM] Device Method payload : {} [7/14/2020 9:53:43 AM] Response status : 200 [7/14/2020 9:53:43 AM] Response payload : {'Response': 'The fan has been (re)activated at 2020-07-14 11:53:43.095383'} You should now have two terminal windows open . One with a locally running function app, and one with a Simulated Raspberry Pi. Messages should be flowing back and forth between the services. If this is not the case: Check if your .env file is configured correctly s.t. your Simulated Raspberry Pi can send data to the cloud. Make sure your Stream Analytics Job is running (see: Starting the analysis job on Stream Analytics ) Verify if messages are received on the cloud by checking if data is written to the storage account container named temperature . This should contain one or multiple jsonfiles with data from the Raspberry Pi. if messages are sent to the Service Bus Queue. You can navigate in the Azure Portal to the Queue and look if there are messages in the Queue. Remember that if your function app is running locally, it will consume all messages on that queue instantly, hence the queue will become empty almost instantaniously whilst the function app is running. 4/4 Deploying your function app to Azure \u00b6 Now your function app is tested locally, you can deploy it to Azure. You can stop the services in both terminals, and execute the following command: # 1. Deploy the function to Azure. (replace the function app name with your own) func azure functionapp publish functionapp-pndvv72m6ihab This will use the Azure Functions library to deploy your function to the cloud. after a minute or so you can open the Azure Portal, navigate to your function app and find your function deployed and well.","title":"Old"},{"location":"old/#prerequisites","text":"Azure account with a subscription you are allowed to create resources in (Free Trial Subscription should do) Make sure you have installed the Azure CLI on your computer basic knowledge of git + python virtual environments access to a bash-like terminal","title":"Prerequisites"},{"location":"old/#deploying-infrastructure","text":"I've defined the infrastructure in an ARM template . This allows you to press the button below and deploy the infrastructure to your own Azure account with the click of a button. Press the 'Deploy to Azure' button above to create a custom deployment in Azure Login to your Azure Account where you want to create the application (if not logged in yet) You should then see the Custom Deployment screen as in the screenshot below. Here you can specify some settings for the Deployment. Select a subscription in which you want to create the resources in Create a new resourcegroup in which you want to deploy these resources Keep all the other settings as default, unless you know what you're doing and want to change something Scroll down, accept the terms and conditions and click Purchase. IMPORTANT Remember that this deployment and the running of it will cost you money. For me, I didn't pay more that a few euros and I let it run for a month or so. Please remember to remove your resources if you're not using them anymore! After a couple of minutes (+- 5 minutes I guess) your infrastructure deployment should be completed. Navigate to the resource group you've created to see the different services you've deployed.","title":"Deploying Infrastructure"},{"location":"old/#starting-services","text":"You should now have the individual components deployed within your Resource Group. Navigate to your resource group overview, and you'll see something like this. To use our end-to-end application, we must activate and configure some of our individual services. We're going to do that now.","title":"Starting Services"},{"location":"old/#registering-a-device-on-iot-hub","text":"The Azure IoT Hub is a managed service, hosted in the cloud, that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages. You can use Azure IoT Hub to build IoT solutions with reliable and secure communications between millions of IoT devices and a cloud-hosted solution backend. You can connect virtually any device to IoT Hub. Today we're going to connect only one device. To register a device on IoT Hub: 1. Go to your IoT Hub resource and select the menu blade IoT Devices (see screenshot below) 2. Register a New device by clicking + New 3. In the \"Create a Device\" tab, write down a Device ID , for example MyRaspberryPi . This should be a identifier unique within the IoT Hub. 4. Leave everything else to it's default values and press Save . 5. You have succesfully registered a device on IoT Hub ! You will come back to this screen later to copy the (Primary) Connection String to your local configuration file (your .env file) to allow your device to connect to IoT Hub. We will do this later though, once we're doing configuring the infrastructure.","title":"Registering a device on IoT Hub"},{"location":"old/#starting-the-analysis-job-on-stream-analytics","text":"Azure Stream Analytics is a real-time analytics and complex event-processing engine that is designed to analyze and process high volumes of fast streaming data from multiple sources simultaneously. Patterns can be identified from a number of input sources including devices, sensors and applications. These patterns can be used to trigger actions and initiate workflows such as creating alerts, feeding information to a reporting tool, or storing transformed data for later use. We will use Stream Analytics to ingest data from IoT Hub and move it to both Blob Storage and a Service Bus Queue for more complex actions. This is already configured for you when the infrastructure was deployed, the only thing we need to do is Start the Streaming Job . Navigate to your Stream Analytics resource and you will see the the Overview page . On the bottom right you will see the Query that is already pre-defined. This query does 2 things. (it shown below as well for convenience) it moves all data from the input called iothub to the output called blobstorage it moves all data where temperature > 29 from the input called iothub to the output called servicebus SELECT * INTO blobstorage FROM iothub SELECT * INTO servicebus FROM iothub WHERE temperature > 29 If you want to learn how this input and outputs are actually coupled to the IoT Hub and Service Bus in our infrastructure, you can navigate to the menu blades on the left of your screen called inputs and outputs (under Job Topology ). At deployment time, the bindings to these services were already done for you so you don't have to worry about them. If you want to learn how to create these yourself, I recommend This video by Adam Marczak on Azure Stream Analytics. I fact, I recommend all his Azure tutorials, which helped me a great deal in developing this project. Now you know roughly what happens in Stream Analytics, we can start this Stream Analytics Job to start processing incoming requests. Remember that we're not sending any data from a device yet to our application, but we're just preconfiguring the infrastrature. Press the > Start button at the top of the Overview menu to start the job. It takes about a minute or two to activate, you can see the status straight below it. (see screenshot below) You have sucessfully started your Steam Analytics job! In a bit, our Raspberry Pi Data will flow through this job to the connected services. Now it's not doing anything yet though, So lets quickly finish up our infrastructure setup to start sending data. Cost saving Tip: Pause your stream Analytics job once your done developing. You don't pay per request, but per hour.","title":"Starting the analysis job on Stream Analytics"},{"location":"old/#deploying-a-function-to-azure-functions","text":"Azure Functions is a serverless compute service that lets you run event-triggered code without having to explicitly provision or manage infrastructure. A function is \"triggered\" by a specific type of event. Supported triggers include responding to changes in data, responding to messages, running on a schedule, or as the result of an HTTP request. In our application, we're going to start a function when we receive a message on our Service Bus Queue. A function can be deployed within Azure Functions, and can be developed locally on your computer. We're going to deploy a function that I already prepared for this demo. Make sure you have installed the Azure CLI on your computer. you can test this by running az --version in your terminal.","title":"Deploying a function to Azure Functions"},{"location":"old/#14-downloading-the-repository","text":"# 1. Clone this repository to your computer. git clone https://github.com/sandervandorsten/azure-iothub-demo.git # Cloning into 'azure-iothub-demo'... # ... # Resolving deltas: 100% ..., done. # 2. navigate into the git repository cd azure-iothub-demo # 3. Create a virtual environment with python 3.7 and install the requirements virtualenv -p $( which python3.7 ) venv source venv/bin/activate pip install -r requirements.txt","title":"1/4: Downloading the repository"},{"location":"old/#24-running-our-functions-application-locally","text":"Now we have our code and python environment locally, we can test our function app locally before we deploy it to our cloud project. The code that will be run in the function can be found in src/azure_functions/ServiceBusQueueTriggerTemperature/__init__.py in this repository, you can check it out if you like. To start our function app locally: # 1. Navigate to the folder containing the source code for Azure Functions cd src/azure_functions # 2. Download the application settings from the cloud. # These are the environment variables that will be used to connect Azure Functions # to different services, such as storage and the IoT Hub. # it will store the configuration files automatically in `src/azure_functions/local.settings.json`. # Note that you should replace the functionapp name with your own!! func azure functionapp fetch-app-settings functionapp-pndvv72m6ihab # App Settings: # Loading FUNCTIONS_WORKER_RUNTIME = ***** # Loading FUNCTIONS_EXTENSION_VERSION = ***** # Loading AzureWebJobsStorage = ***** # Loading connectionStringListenServiceBus = ***** # Loading connectionStringIotHub = ***** # 3. Start the function app locally. This will start a local webserver on port 7071. # Our function should then run locally on your computer, # but listens to the Service Bus Queue in the cloud. func start # Found Python version 3.7.5 (python3). # %%%%%% # %%%%%% # @ %%%%%% @ # @@ %%%%%% @@ # @@@ %%%%%%%%%%% @@@ # @@ %%%%%%%%%% @@ # @@ %%%% @@ # @@ %%% @@ # @@ %% @@ # %% # % # ... # Content root path: /.../azure-iothub-demo/src/azure_functions # Now listening on: http://0.0.0.0:7071 # Application started. Press Ctrl+C to shut down.","title":"2/4: Running our functions application locally"},{"location":"old/#34-simulating-a-raspberrypi-locally","text":"Running our function app was the last step of infrastructure that we should enable before we can start testing our whole setup. Now, we need to connect a IoT Device to the IoT Hub s.t. we can send device-to-cloud telemetry towards our cloud application, and receive cloud-to-device messages from our function app. I've created a Raspberry Pi Interface in azure-iothub-demo/src/iothub/device.py that we're going to use to simulate a Raspberry Pi . You can connect your own raspberry Pi to do the actual work, but this is (currently) beyond the scope of this tutorial. To start a Raspberry Pi simulation, open an extra terminal window (leaving the one running the function app open!) and running the following snippets: # 0. Navigate to the azure-iothub-demo folder and activate the virtual environment in this terminal as well source venv/bin/activate # 1. Copy the sanmple.env file to .env file s.t. we can store essential credentials here later cp sample.env .env # 2. Download the azure IoT Hub Extension to interact with our cloud application az extension add --name azure-iot # 3. Save your unique IoT Hub name (see your own Azure Portal with the name of your Iot Hub resource Name) and DeviceId s.t. we can use them below export IoTHubName = \"rpi-iothub-.........\" export deviceId = \"MyRaspberryPi\" # 4. Access the connection string for the IoT Hub in your terminal az iot hub show-connection-string \\ --name $IoTHubName \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI= # 5. Access the Connection String for the DeviceId you've created in IoT Hub. az iot hub device-identity show-connection-string \\ --hub-name $IoTHubName \\ --device-id $deviceId \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ= Now, open the .env file with a text editor and replace the string values s.t. it looks like this DEVICE_ID = \"MyRaspberryPi\" CONNECTION_STRING_IOT_DEVICE = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ=\" CONNECTION_STRING_IOT_HUB = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI=\" Save the .env file and close it. . This file contains credentials and should not be shared, or stored publicly! Now the configuration is finished, you can start the RaspberryPi simulation . the Simulated Raspberry Pi will: send a random temperature value every 3 seconds to the IoT Hub. listen to it's IoT Hub for messages. Our function app will send messages to the device through the IoT Hub to start the fan if temperature > 29 (as configured in our Stream Analytics Job). The fan will then be turned on for 10 seconds, and deactivated afterwards. Hence, if the temperature will stay above 29 degrees, the fan will stay on because the RaspberryPi will keep receiving messages to turn on the fan. To start the Raspberry Pi simulation , re-use the second terminal window and execute the following commands: # 6. navigate to the iothub folder and run the Raspberry Pi simulation cd src/iothub python main.py --RPi SimulatedRaspberryPi # IoT Hub device sending periodic messages, press Ctrl-C to exit # Sending message: {\"temperature\": 33.794175910136936, \"fan_active\": false} # Message sent # Sending message: {\"temperature\": 22.667180109040924, \"fan_active\": false} # Message sent # ... Once the Raspberry Pi sends a message with a temperature > 29 , this message will be forwarded by the Stream Analytics Job to the Service Bus Queue. Once this message arrives on the Service Bus Queue, it will trigger the Function app (that is running locally on your computer), which sends a message through the IoTHub to the device that the fan should be activated. The logs in your terminal of your function app should look something like this: [7/14/2020 9:53:43 AM] Executing 'Functions.ServiceBusQueueTriggerTemperature' (Reason='New ServiceBus message detected on 'temperature'.', Id=161614bf-3d3a-40f7-8608-7e2c88d08ba0) [7/14/2020 9:53:43 AM] Trigger Details: MessageId: a5f9ddcd698142e495a1cec97f954071, DeliveryCount: 10, EnqueuedTime: 7/14/2020 9:53:42 AM, LockedUntil: 7/14/2020 9:58:43 AM, SessionId: 18725 [7/14/2020 9:53:43 AM] INFO: Received FunctionInvocationRequest, request ID: 2f46689a-8f66-4dab-88da-6381e553e3f2, function ID: 4065367e-45d4-45f3-bb6e-416b2fdeed51, invocation ID: 161614bf-3d3a-40f7-8608-7e2c88d08ba0 [7/14/2020 9:53:43 AM] Python ServiceBus queue trigger processed message: {'temperature': 30.463195551136046, 'fan_active': 1, 'EventProcessedUtcTime': '2020-07-14T09:53:36.6114953Z', 'PartitionId': 1, 'EventEnqueuedUtcTime': '2020-07-14T09:53:36.5600000Z', 'IoTHub': {'MessageId': None, 'CorrelationId': None, 'ConnectionDeviceId': 'MyRaspberryPi', 'ConnectionDeviceGenerationId': '637298794990585953', 'EnqueuedTime': '2020-07-14T09:53:36.0000000', 'StreamId': None}} [7/14/2020 9:53:43 AM] Device Method called [7/14/2020 9:53:43 AM] Device Method name : start_fan [7/14/2020 9:53:43 AM] Device Method payload : {} [7/14/2020 9:53:43 AM] Response status : 200 [7/14/2020 9:53:43 AM] Response payload : {'Response': 'The fan has been (re)activated at 2020-07-14 11:53:43.095383'} You should now have two terminal windows open . One with a locally running function app, and one with a Simulated Raspberry Pi. Messages should be flowing back and forth between the services. If this is not the case: Check if your .env file is configured correctly s.t. your Simulated Raspberry Pi can send data to the cloud. Make sure your Stream Analytics Job is running (see: Starting the analysis job on Stream Analytics ) Verify if messages are received on the cloud by checking if data is written to the storage account container named temperature . This should contain one or multiple jsonfiles with data from the Raspberry Pi. if messages are sent to the Service Bus Queue. You can navigate in the Azure Portal to the Queue and look if there are messages in the Queue. Remember that if your function app is running locally, it will consume all messages on that queue instantly, hence the queue will become empty almost instantaniously whilst the function app is running.","title":"3/4: Simulating a RaspberryPi Locally"},{"location":"old/#44-deploying-your-function-app-to-azure","text":"Now your function app is tested locally, you can deploy it to Azure. You can stop the services in both terminals, and execute the following command: # 1. Deploy the function to Azure. (replace the function app name with your own) func azure functionapp publish functionapp-pndvv72m6ihab This will use the Azure Functions library to deploy your function to the cloud. after a minute or so you can open the Azure Portal, navigate to your function app and find your function deployed and well.","title":"4/4 Deploying your function app to Azure"},{"location":"Installation/function/","text":"Azure Functions: Deploying a function What is Azure Functions? \u00b6 Azure Functions is a serverless compute service that lets you run event-triggered code without having to explicitly provision or manage infrastructure. A function is \"triggered\" by a specific type of event. Supported triggers include responding to changes in data, responding to messages, running on a schedule, or as the result of an HTTP request. Usage \u00b6 In our application, we're going to start a function when we receive a message on our Service Bus Queue. A function can be deployed within Azure Functions, and can be developed locally on your computer. Prerequisites \u00b6 Make sure you have installed the Azure CLI on your computer basic knowledge of git + python virtual environments access to a bash-like terminal Downloading the repository \u00b6 Clone this repository to your computer. git clone https://github.com/sandervandorsten/azure-iothub-demo.git # Cloning into 'azure-iothub-demo'... # ... # Resolving deltas: 100% ..., done. Navigate into the git repository cd azure-iothub-demo Create a virtual environment with python 3.7 and install the requirements virtualenv -p $( which python3.7 ) venv source venv/bin/activate pip install -r requirements.txt Running our functions application locally \u00b6 Now we have our code and python environment locally, we can test our function app locally before we deploy it to our cloud project. The code that will be run in the function can be found in src/azure_functions/ServiceBusQueueTriggerTemperature/__init__.py in this repository, you can check it out if you like. To start our function app locally: Navigate to the folder containing the source code for Azure Functions cd src/azure_functions Download the application settings from the cloud. These are the environment variables that will be used to connect Azure Functions to different services, such as storage and the IoT Hub. it will store the configuration files automatically in src/azure_functions/local.settings.json . Replace the functionapp-.... name Remember that you should replace the functionapp name with your own!! func azure functionapp fetch-app-settings functionapp-pndvv72m6ihab # App Settings: # Loading FUNCTIONS_WORKER_RUNTIME = ***** # Loading FUNCTIONS_EXTENSION_VERSION = ***** # Loading AzureWebJobsStorage = ***** # Loading connectionStringListenServiceBus = ***** # Loading connectionStringIotHub = ***** Start the function app locally. This will start a local webserver on port 7071 . Our function should then run locally on your computer, but listens to the Service Bus Queue in the cloud. func start # Found Python version 3.7.5 (python3). # %%%%%% # %%%%%% # @ %%%%%% @ # @@ %%%%%% @@ # @@@ %%%%%%%%%%% @@@ # @@ %%%%%%%%%% @@ # @@ %%%% @@ # @@ %%% @@ # @@ %% @@ # %% # % # ... # Content root path: /.../azure-iothub-demo/src/azure_functions # Now listening on: http://0.0.0.0:7071 # Application started. Press Ctrl+C to shut down. Simulating a RaspberryPi Locally \u00b6 Running our function app was the last step of infrastructure that we should enable before we can start testing our whole setup. Now, we need to connect a IoT Device to the IoT Hub s.t. we can send device-to-cloud telemetry towards our cloud application, and receive cloud-to-device messages from our function app. I've created a Raspberry Pi Interface in azure-iothub-demo/src/iothub/device.py that we're going to use to simulate a Raspberry Pi . You can connect your own raspberry Pi to do the actual work, but this is (currently) beyond the scope of this tutorial. To start a Raspberry Pi simulation, open an extra terminal window (leaving the one running the function app open!) and running the following snippets: Configuration \u00b6 Navigate to the azure-iothub-demo folder and activate the virtual environment in this terminal as well source venv/bin/activate Copy the sample.env file to .env file s.t. we can store essential credentials here later cp sample.env .env Download the azure IoT Hub Extension to interact with your cloud application az extension add --name azure-iot Save your unique IoT Hub name (see your own Azure Portal with the name of your Iot Hub resource Name) and DeviceId s.t. we can use them below export IoTHubName = \"rpi-iothub-.........\" export deviceId = \"MyRaspberryPi\" Access the connection string for the IoT Hub in your terminal az iot hub show-connection-string \\ --name $IoTHubName \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI= Access the Connection String for the DeviceId you've created in IoT Hub. az iot hub device-identity show-connection-string \\ --hub-name $IoTHubName \\ --device-id $deviceId \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ= Now, open the .env file with a text editor and replace the string values s.t. it looks like this DEVICE_ID = \"MyRaspberryPi\" CONNECTION_STRING_IOT_DEVICE = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ=\" CONNECTION_STRING_IOT_HUB = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI=\" Save the .env file and close it. .env file This file contains credentials and should not be shared, or stored publicly! Starting the Raspberry Pi \u00b6 Now the configuration is finished, you can start the RaspberryPi simulation . the Simulated Raspberry Pi will: send a random temperature value every 3 seconds to the IoT Hub. listen to it's IoT Hub for messages. Our function app will send messages to the device through the IoT Hub to start the fan if temperature > 29 (as configured in our Stream Analytics Job). The fan will then be turned on for 10 seconds, and deactivated afterwards. Hence, if the temperature will stay above 29 degrees, the fan will stay on because the RaspberryPi will keep receiving messages to turn on the fan. navigate to the iothub folder and run the Raspberry Pi simulation cd src/iothub python main.py --RPi SimulatedRaspberryPi # IoT Hub device sending periodic messages, press Ctrl-C to exit # Sending message: {\"temperature\": 33.794175910136936, \"fan_active\": false} # Message sent # Sending message: {\"temperature\": 22.667180109040924, \"fan_active\": false} # Message sent # ... Once the Raspberry Pi sends a message with a temperature > 29 , this message will be forwarded by the Stream Analytics Job to the Service Bus Queue. Once this message arrives on the Service Bus Queue, it will trigger the Function app (that is running locally on your computer), which sends a message through the IoTHub to the device that the fan should be activated. The logs in your terminal of your function app should look something like this: [7/14/2020 9:53:43 AM] Executing 'Functions.ServiceBusQueueTriggerTemperature' (Reason='New ServiceBus message detected on 'temperature'.', Id=161614bf-3d3a-40f7-8608-7e2c88d08ba0) [7/14/2020 9:53:43 AM] Trigger Details: MessageId: a5f9ddcd698142e495a1cec97f954071, DeliveryCount: 10, EnqueuedTime: 7/14/2020 9:53:42 AM, LockedUntil: 7/14/2020 9:58:43 AM, SessionId: 18725 [7/14/2020 9:53:43 AM] INFO: Received FunctionInvocationRequest, request ID: 2f46689a-8f66-4dab-88da-6381e553e3f2, function ID: 4065367e-45d4-45f3-bb6e-416b2fdeed51, invocation ID: 161614bf-3d3a-40f7-8608-7e2c88d08ba0 [7/14/2020 9:53:43 AM] Python ServiceBus queue trigger processed message: {'temperature': 30.463195551136046, 'fan_active': 1, 'EventProcessedUtcTime': '2020-07-14T09:53:36.6114953Z', 'PartitionId': 1, 'EventEnqueuedUtcTime': '2020-07-14T09:53:36.5600000Z', 'IoTHub': {'MessageId': None, 'CorrelationId': None, 'ConnectionDeviceId': 'MyRaspberryPi', 'ConnectionDeviceGenerationId': '637298794990585953', 'EnqueuedTime': '2020-07-14T09:53:36.0000000', 'StreamId': None}} [7/14/2020 9:53:43 AM] Device Method called [7/14/2020 9:53:43 AM] Device Method name : start_fan [7/14/2020 9:53:43 AM] Device Method payload : {} [7/14/2020 9:53:43 AM] Response status : 200 [7/14/2020 9:53:43 AM] Response payload : {'Response': 'The fan has been (re)activated at 2020-07-14 11:53:43.095383'} Summary \u00b6 You should now have two terminal windows open . One with a locally running function app, and one with a Simulated Raspberry Pi. Messages should be flowing back and forth between the services. Debugging \u00b6 If this is not the case: Check if your .env file is configured correctly s.t. your Simulated Raspberry Pi can send data to the cloud. Make sure your Stream Analytics Job is running (see: Starting the analysis job on Stream Analytics ) Verify if messages are received on the cloud by checking if data is written to the storage account container named temperature . This should contain one or multiple jsonfiles with data from the Raspberry Pi. if messages are sent to the Service Bus Queue. You can navigate in the Azure Portal to the Queue and look if there are messages in the Queue. Empty Service Bus Queue Remember that if your function app is running (locally), it will consume all messages on that queue instantly , hence the queue will become empty almost instantaniously whilst the function app is running. Deploying your function app to Azure \u00b6 Now your function app is tested locally, you can deploy it to Azure. You can stop the services in both terminals. Deploy the function to Azure. (replace the function app name with your own) func azure functionapp publish functionapp-pndvv72m6ihab This will use the Azure Functions library to deploy your function to the cloud. after a minute or so you can open the Azure Portal, navigate to your function app and find your function deployed and well. Recap \u00b6 test Next Steps \u00b6 test","title":"Azure Function: Deploying a function"},{"location":"Installation/function/#what-is-azure-functions","text":"Azure Functions is a serverless compute service that lets you run event-triggered code without having to explicitly provision or manage infrastructure. A function is \"triggered\" by a specific type of event. Supported triggers include responding to changes in data, responding to messages, running on a schedule, or as the result of an HTTP request.","title":"What is Azure Functions?"},{"location":"Installation/function/#usage","text":"In our application, we're going to start a function when we receive a message on our Service Bus Queue. A function can be deployed within Azure Functions, and can be developed locally on your computer.","title":"Usage"},{"location":"Installation/function/#prerequisites","text":"Make sure you have installed the Azure CLI on your computer basic knowledge of git + python virtual environments access to a bash-like terminal","title":"Prerequisites"},{"location":"Installation/function/#downloading-the-repository","text":"Clone this repository to your computer. git clone https://github.com/sandervandorsten/azure-iothub-demo.git # Cloning into 'azure-iothub-demo'... # ... # Resolving deltas: 100% ..., done. Navigate into the git repository cd azure-iothub-demo Create a virtual environment with python 3.7 and install the requirements virtualenv -p $( which python3.7 ) venv source venv/bin/activate pip install -r requirements.txt","title":"Downloading the repository"},{"location":"Installation/function/#running-our-functions-application-locally","text":"Now we have our code and python environment locally, we can test our function app locally before we deploy it to our cloud project. The code that will be run in the function can be found in src/azure_functions/ServiceBusQueueTriggerTemperature/__init__.py in this repository, you can check it out if you like. To start our function app locally: Navigate to the folder containing the source code for Azure Functions cd src/azure_functions Download the application settings from the cloud. These are the environment variables that will be used to connect Azure Functions to different services, such as storage and the IoT Hub. it will store the configuration files automatically in src/azure_functions/local.settings.json . Replace the functionapp-.... name Remember that you should replace the functionapp name with your own!! func azure functionapp fetch-app-settings functionapp-pndvv72m6ihab # App Settings: # Loading FUNCTIONS_WORKER_RUNTIME = ***** # Loading FUNCTIONS_EXTENSION_VERSION = ***** # Loading AzureWebJobsStorage = ***** # Loading connectionStringListenServiceBus = ***** # Loading connectionStringIotHub = ***** Start the function app locally. This will start a local webserver on port 7071 . Our function should then run locally on your computer, but listens to the Service Bus Queue in the cloud. func start # Found Python version 3.7.5 (python3). # %%%%%% # %%%%%% # @ %%%%%% @ # @@ %%%%%% @@ # @@@ %%%%%%%%%%% @@@ # @@ %%%%%%%%%% @@ # @@ %%%% @@ # @@ %%% @@ # @@ %% @@ # %% # % # ... # Content root path: /.../azure-iothub-demo/src/azure_functions # Now listening on: http://0.0.0.0:7071 # Application started. Press Ctrl+C to shut down.","title":"Running our functions application locally"},{"location":"Installation/function/#simulating-a-raspberrypi-locally","text":"Running our function app was the last step of infrastructure that we should enable before we can start testing our whole setup. Now, we need to connect a IoT Device to the IoT Hub s.t. we can send device-to-cloud telemetry towards our cloud application, and receive cloud-to-device messages from our function app. I've created a Raspberry Pi Interface in azure-iothub-demo/src/iothub/device.py that we're going to use to simulate a Raspberry Pi . You can connect your own raspberry Pi to do the actual work, but this is (currently) beyond the scope of this tutorial. To start a Raspberry Pi simulation, open an extra terminal window (leaving the one running the function app open!) and running the following snippets:","title":"Simulating a RaspberryPi Locally"},{"location":"Installation/function/#configuration","text":"Navigate to the azure-iothub-demo folder and activate the virtual environment in this terminal as well source venv/bin/activate Copy the sample.env file to .env file s.t. we can store essential credentials here later cp sample.env .env Download the azure IoT Hub Extension to interact with your cloud application az extension add --name azure-iot Save your unique IoT Hub name (see your own Azure Portal with the name of your Iot Hub resource Name) and DeviceId s.t. we can use them below export IoTHubName = \"rpi-iothub-.........\" export deviceId = \"MyRaspberryPi\" Access the connection string for the IoT Hub in your terminal az iot hub show-connection-string \\ --name $IoTHubName \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI= Access the Connection String for the DeviceId you've created in IoT Hub. az iot hub device-identity show-connection-string \\ --hub-name $IoTHubName \\ --device-id $deviceId \\ --output table #HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ= Now, open the .env file with a text editor and replace the string values s.t. it looks like this DEVICE_ID = \"MyRaspberryPi\" CONNECTION_STRING_IOT_DEVICE = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;DeviceId=MyRaspberryPi;SharedAccessKey=bHnH82Pn21X0QPVkrFCban/XTEml5zAVR8YkiccgZPQ=\" CONNECTION_STRING_IOT_HUB = \"HostName=rpi-iothub-pndvv72m6ihab.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=BhkccChKy2ii4SdlXw00/1NtD0p6nssS0MIHoWqZODI=\" Save the .env file and close it. .env file This file contains credentials and should not be shared, or stored publicly!","title":"Configuration"},{"location":"Installation/function/#starting-the-raspberry-pi","text":"Now the configuration is finished, you can start the RaspberryPi simulation . the Simulated Raspberry Pi will: send a random temperature value every 3 seconds to the IoT Hub. listen to it's IoT Hub for messages. Our function app will send messages to the device through the IoT Hub to start the fan if temperature > 29 (as configured in our Stream Analytics Job). The fan will then be turned on for 10 seconds, and deactivated afterwards. Hence, if the temperature will stay above 29 degrees, the fan will stay on because the RaspberryPi will keep receiving messages to turn on the fan. navigate to the iothub folder and run the Raspberry Pi simulation cd src/iothub python main.py --RPi SimulatedRaspberryPi # IoT Hub device sending periodic messages, press Ctrl-C to exit # Sending message: {\"temperature\": 33.794175910136936, \"fan_active\": false} # Message sent # Sending message: {\"temperature\": 22.667180109040924, \"fan_active\": false} # Message sent # ... Once the Raspberry Pi sends a message with a temperature > 29 , this message will be forwarded by the Stream Analytics Job to the Service Bus Queue. Once this message arrives on the Service Bus Queue, it will trigger the Function app (that is running locally on your computer), which sends a message through the IoTHub to the device that the fan should be activated. The logs in your terminal of your function app should look something like this: [7/14/2020 9:53:43 AM] Executing 'Functions.ServiceBusQueueTriggerTemperature' (Reason='New ServiceBus message detected on 'temperature'.', Id=161614bf-3d3a-40f7-8608-7e2c88d08ba0) [7/14/2020 9:53:43 AM] Trigger Details: MessageId: a5f9ddcd698142e495a1cec97f954071, DeliveryCount: 10, EnqueuedTime: 7/14/2020 9:53:42 AM, LockedUntil: 7/14/2020 9:58:43 AM, SessionId: 18725 [7/14/2020 9:53:43 AM] INFO: Received FunctionInvocationRequest, request ID: 2f46689a-8f66-4dab-88da-6381e553e3f2, function ID: 4065367e-45d4-45f3-bb6e-416b2fdeed51, invocation ID: 161614bf-3d3a-40f7-8608-7e2c88d08ba0 [7/14/2020 9:53:43 AM] Python ServiceBus queue trigger processed message: {'temperature': 30.463195551136046, 'fan_active': 1, 'EventProcessedUtcTime': '2020-07-14T09:53:36.6114953Z', 'PartitionId': 1, 'EventEnqueuedUtcTime': '2020-07-14T09:53:36.5600000Z', 'IoTHub': {'MessageId': None, 'CorrelationId': None, 'ConnectionDeviceId': 'MyRaspberryPi', 'ConnectionDeviceGenerationId': '637298794990585953', 'EnqueuedTime': '2020-07-14T09:53:36.0000000', 'StreamId': None}} [7/14/2020 9:53:43 AM] Device Method called [7/14/2020 9:53:43 AM] Device Method name : start_fan [7/14/2020 9:53:43 AM] Device Method payload : {} [7/14/2020 9:53:43 AM] Response status : 200 [7/14/2020 9:53:43 AM] Response payload : {'Response': 'The fan has been (re)activated at 2020-07-14 11:53:43.095383'}","title":"Starting the Raspberry Pi"},{"location":"Installation/function/#summary","text":"You should now have two terminal windows open . One with a locally running function app, and one with a Simulated Raspberry Pi. Messages should be flowing back and forth between the services.","title":"Summary"},{"location":"Installation/function/#debugging","text":"If this is not the case: Check if your .env file is configured correctly s.t. your Simulated Raspberry Pi can send data to the cloud. Make sure your Stream Analytics Job is running (see: Starting the analysis job on Stream Analytics ) Verify if messages are received on the cloud by checking if data is written to the storage account container named temperature . This should contain one or multiple jsonfiles with data from the Raspberry Pi. if messages are sent to the Service Bus Queue. You can navigate in the Azure Portal to the Queue and look if there are messages in the Queue. Empty Service Bus Queue Remember that if your function app is running (locally), it will consume all messages on that queue instantly , hence the queue will become empty almost instantaniously whilst the function app is running.","title":"Debugging"},{"location":"Installation/function/#deploying-your-function-app-to-azure","text":"Now your function app is tested locally, you can deploy it to Azure. You can stop the services in both terminals. Deploy the function to Azure. (replace the function app name with your own) func azure functionapp publish functionapp-pndvv72m6ihab This will use the Azure Functions library to deploy your function to the cloud. after a minute or so you can open the Azure Portal, navigate to your function app and find your function deployed and well.","title":"Deploying your function app to Azure"},{"location":"Installation/function/#recap","text":"test","title":"Recap"},{"location":"Installation/function/#next-steps","text":"test","title":"Next Steps"},{"location":"Installation/iot-hub/","text":"IoT Hub: Registering a Device What is Azure IoT Hub \u00b6 The Azure IoT Hub is a managed service, hosted in the cloud, that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages. You can use Azure IoT Hub to build IoT solutions with reliable and secure communications between millions of IoT devices and a cloud-hosted solution backend. You can connect virtually any device to IoT Hub. Installation \u00b6 Today we're going to connect only one device. To register a device on IoT Hub: Go to your IoT Hub resource and select the menu blade IoT Devices (see screenshot below) Register a New device by clicking + New In the \"Create a Device\" tab, write down a Device ID , for example MyRaspberryPi . This should be a identifier unique within the IoT Hub. Leave everything else to it's default values and press Save . Recap \u00b6 You have succesfully registered a device on IoT Hub ! You may come back to this screen later to copy the (Primary) Connection String to your local configuration file (your .env file) to allow your device to connect to IoT Hub. We will do this later though, once we're doing installing all the different Azure services. Next Steps \u00b6 Now you've configured everything for IoT Hub, you'll continue by setting up your Stream Analytics Job","title":"IoT Hub: Registering A Device"},{"location":"Installation/iot-hub/#what-is-azure-iot-hub","text":"The Azure IoT Hub is a managed service, hosted in the cloud, that acts as a central message hub for bi-directional communication between your IoT application and the devices it manages. You can use Azure IoT Hub to build IoT solutions with reliable and secure communications between millions of IoT devices and a cloud-hosted solution backend. You can connect virtually any device to IoT Hub.","title":"What is Azure IoT Hub"},{"location":"Installation/iot-hub/#installation","text":"Today we're going to connect only one device. To register a device on IoT Hub: Go to your IoT Hub resource and select the menu blade IoT Devices (see screenshot below) Register a New device by clicking + New In the \"Create a Device\" tab, write down a Device ID , for example MyRaspberryPi . This should be a identifier unique within the IoT Hub. Leave everything else to it's default values and press Save .","title":"Installation"},{"location":"Installation/iot-hub/#recap","text":"You have succesfully registered a device on IoT Hub ! You may come back to this screen later to copy the (Primary) Connection String to your local configuration file (your .env file) to allow your device to connect to IoT Hub. We will do this later though, once we're doing installing all the different Azure services.","title":"Recap"},{"location":"Installation/iot-hub/#next-steps","text":"Now you've configured everything for IoT Hub, you'll continue by setting up your Stream Analytics Job","title":"Next Steps"},{"location":"Installation/stream-analytics/","text":"Stream Analytics: Starting the Analysis Job What is Stream Analytics \u00b6 Azure Stream Analytics is a real-time analytics and complex event-processing engine that is designed to analyze and process high volumes of fast streaming data from multiple sources simultaneously. Patterns can be identified from a number of input sources including devices, sensors and applications. These patterns can be used to trigger actions and initiate workflows such as creating alerts, feeding information to a reporting tool, or storing transformed data for later use. Usage \u00b6 We will use Stream Analytics to ingest data from IoT Hub and move it to both Blob Storage and a Service Bus Queue for more complex actions. This is already configured for you when the infrastructure was deployed, the only thing we need to do is Start the Streaming Job . Installation \u00b6 Navigate to your Stream Analytics resource and you will see the the Overview page . On the bottom right you will see the Query that is already pre-defined. This query does 2 things. (it shown below as well for convenience) it moves all data from the input called iothub to the output called blobstorage it moves all data where temperature > 29 from the input called iothub to the output called servicebus SELECT * INTO blobstorage FROM iothub SELECT * INTO servicebus FROM iothub WHERE temperature > 29 If you want to learn how this input and outputs are actually coupled to the IoT Hub and Service Bus in our infrastructure, you can navigate to the menu blades on the left of your screen called inputs and outputs (under Job Topology ). At deployment time, the bindings to these services were already done for you so you don't have to worry about them. Creating input and output bindings If you want to learn how to create these yourself, I recommend This video by Adam Marczak on Azure Stream Analytics. I fact, I recommend all his Azure tutorials, which helped me a great deal in developing this project. Now you know roughly what happens in Stream Analytics, we can start this Stream Analytics Job to start processing incoming requests. Remember that we're not sending any data from a device yet to our application, but we're just preconfiguring the infrastrature. Press the > Start button at the top of the Overview menu to start the job. It takes about a minute or two to activate, you can see the status straight below it. (see screenshot below) Recap \u00b6 You have sucessfully started your Steam Analytics job! In a bit, our Raspberry Pi Data will flow through this job to the connected services. Now it's not doing anything yet though, So lets quickly finish up our infrastructure setup to start sending data. Cost Saving Tip Pause your stream Analytics job once your done developing. You don't pay per request, but per hour. Next Steps \u00b6 The last service we need to get up and running is Azure Function","title":"Stream Analytics: Starting the analysis job"},{"location":"Installation/stream-analytics/#what-is-stream-analytics","text":"Azure Stream Analytics is a real-time analytics and complex event-processing engine that is designed to analyze and process high volumes of fast streaming data from multiple sources simultaneously. Patterns can be identified from a number of input sources including devices, sensors and applications. These patterns can be used to trigger actions and initiate workflows such as creating alerts, feeding information to a reporting tool, or storing transformed data for later use.","title":"What is Stream Analytics"},{"location":"Installation/stream-analytics/#usage","text":"We will use Stream Analytics to ingest data from IoT Hub and move it to both Blob Storage and a Service Bus Queue for more complex actions. This is already configured for you when the infrastructure was deployed, the only thing we need to do is Start the Streaming Job .","title":"Usage"},{"location":"Installation/stream-analytics/#installation","text":"Navigate to your Stream Analytics resource and you will see the the Overview page . On the bottom right you will see the Query that is already pre-defined. This query does 2 things. (it shown below as well for convenience) it moves all data from the input called iothub to the output called blobstorage it moves all data where temperature > 29 from the input called iothub to the output called servicebus SELECT * INTO blobstorage FROM iothub SELECT * INTO servicebus FROM iothub WHERE temperature > 29 If you want to learn how this input and outputs are actually coupled to the IoT Hub and Service Bus in our infrastructure, you can navigate to the menu blades on the left of your screen called inputs and outputs (under Job Topology ). At deployment time, the bindings to these services were already done for you so you don't have to worry about them. Creating input and output bindings If you want to learn how to create these yourself, I recommend This video by Adam Marczak on Azure Stream Analytics. I fact, I recommend all his Azure tutorials, which helped me a great deal in developing this project. Now you know roughly what happens in Stream Analytics, we can start this Stream Analytics Job to start processing incoming requests. Remember that we're not sending any data from a device yet to our application, but we're just preconfiguring the infrastrature. Press the > Start button at the top of the Overview menu to start the job. It takes about a minute or two to activate, you can see the status straight below it. (see screenshot below)","title":"Installation"},{"location":"Installation/stream-analytics/#recap","text":"You have sucessfully started your Steam Analytics job! In a bit, our Raspberry Pi Data will flow through this job to the connected services. Now it's not doing anything yet though, So lets quickly finish up our infrastructure setup to start sending data. Cost Saving Tip Pause your stream Analytics job once your done developing. You don't pay per request, but per hour.","title":"Recap"},{"location":"Installation/stream-analytics/#next-steps","text":"The last service we need to get up and running is Azure Function","title":"Next Steps"}]}